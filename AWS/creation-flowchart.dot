digraph "Terraform Blue-Green Deployment Creation Flow" {
  // Graph settings - Top to bottom flow
  rankdir = TB;
  splines = ortho;
  nodesep = 0.8;
  ranksep = 1.0;

  node [
    shape = box,
    style = "rounded,filled",
    fontname = "Arial",
    fontsize = 11,
    width = 3.5
  ];

  edge [
    fontname = "Arial",
    fontsize = 10,
    penwidth = 2
  ];

  // Start node
  start [
    label = "ğŸš€ å¼€å§‹åˆ›å»º\nterraform apply",
    shape = ellipse,
    fillcolor = "#4CAF50",
    fontcolor = white,
    fontsize = 13,
    style = "filled,bold"
  ];

  // ==================== Stage 1: Foundation ====================
  subgraph cluster_stage1 {
    label = "ç¬¬ 1 é˜¶æ®µï¼šåŸºç¡€ç½‘ç»œå±‚ (0-30 ç§’)";
    style = filled;
    color = "#E3F2FD";
    fontsize = 12;
    fontcolor = "#1565C0";

    step1 [
      label = "æ­¥éª¤ 1: åˆ›å»º VPC\naws_vpc.main\nCIDR: 10.0.0.0/16",
      fillcolor = "#BBDEFB"
    ];

    step2 [
      label = "æ­¥éª¤ 2: åˆ›å»º Internet Gateway\naws_internet_gateway.igw\nè¿æ¥åˆ° VPC",
      fillcolor = "#90CAF9"
    ];

    step3 [
      label = "æ­¥éª¤ 3: åˆ›å»º Public Subnets\naws_subnet.public[0,1]\n2 ä¸ªå¯ç”¨åŒº\n10.0.1.0/24, 10.0.2.0/24",
      fillcolor = "#64B5F6"
    ];

    step4 [
      label = "æ­¥éª¤ 4: åˆ›å»ºè·¯ç”±è¡¨\naws_route_table.public\nå…³è” IGWï¼Œå¯ç”¨å…¬ç½‘è®¿é—®",
      fillcolor = "#42A5F5"
    ];
  }

  // ==================== Stage 2: Security ====================
  subgraph cluster_stage2 {
    label = "ç¬¬ 2 é˜¶æ®µï¼šå®‰å…¨å±‚ (30-45 ç§’)";
    style = filled;
    color = "#F3E5F5";
    fontsize = 12;
    fontcolor = "#6A1B9A";

    step5 [
      label = "æ­¥éª¤ 5: åˆ›å»º ALB Security Group\naws_security_group.alb\nå…è®¸: 0.0.0.0/0:80 å…¥ç«™\nå…è®¸: æ‰€æœ‰å‡ºç«™",
      fillcolor = "#E1BEE7"
    ];

    step6 [
      label = "æ­¥éª¤ 6: åˆ›å»º EC2 Security Group\naws_security_group.ec2\nå…è®¸: ALB â†’ EC2:80\nå…è®¸: æ‰€æœ‰å‡ºç«™",
      fillcolor = "#CE93D8"
    ];
  }

  // ==================== Stage 3: Load Balancer ====================
  subgraph cluster_stage3 {
    label = "ç¬¬ 3 é˜¶æ®µï¼šè´Ÿè½½å‡è¡¡å™¨å±‚ (45-90 ç§’)";
    style = filled;
    color = "#FFF9C4";
    fontsize = 12;
    fontcolor = "#F57F00";

    step7 [
      label = "æ­¥éª¤ 7: åˆ›å»º Application Load Balancer\naws_lb.app\nç±»å‹: application\nè·¨ 2 ä¸ª Subnets\nâ± ç­‰å¾… ALB å°±ç»ª (~2 åˆ†é’Ÿ)",
      fillcolor = "#FFF59D"
    ];

    wait1 [
      label = "â³ ç­‰å¾… ALB çŠ¶æ€å˜ä¸º active\nAWS é¢„é…ç½® ALB èŠ‚ç‚¹",
      shape = note,
      fillcolor = "#FFEB3B",
      fontsize = 10
    ];
  }

  // ==================== Stage 4: Target Groups ====================
  subgraph cluster_stage4 {
    label = "ç¬¬ 4 é˜¶æ®µï¼šç›®æ ‡ç»„å±‚ (90-100 ç§’)";
    style = filled;
    color = "#FFECB3";
    fontsize = 12;
    fontcolor = "#E65100";

    step8 [
      label = "æ­¥éª¤ 8: åˆ›å»º Blue Target Group\naws_lb_target_group.blue\nPort: 80, Protocol: HTTP\nâš¡ deregistration_delay: 30s\nå¥åº·æ£€æŸ¥: / æ¯ 15s",
      fillcolor = "#FFE082"
    ];

    step9 [
      label = "æ­¥éª¤ 9: åˆ›å»º Green Target Group\naws_lb_target_group.green\nPort: 80, Protocol: HTTP\nâš¡ deregistration_delay: 30s\nå¥åº·æ£€æŸ¥: / æ¯ 15s",
      fillcolor = "#C8E6C9"
    ];

    parallel1 [
      label = "å¹¶è¡Œåˆ›å»º",
      shape = diamond,
      fillcolor = "#FDD835",
      fontsize = 10
    ];
  }

  // ==================== Stage 5: Launch Templates ====================
  subgraph cluster_stage5 {
    label = "ç¬¬ 5 é˜¶æ®µï¼šå¯åŠ¨æ¨¡æ¿å±‚ (100-110 ç§’) - æå‰åˆ›å»º";
    style = filled;
    color = "#FFCCBC";
    fontsize = 12;
    fontcolor = "#BF360C";

    step10 [
      label = "æ­¥éª¤ 10: åˆ›å»º Blue Launch Template\naws_launch_template.blue\nAMI: Ubuntu 22.04\nInstance Type: t3.micro\nUser Data: è“è‰²ç¯å¢ƒç½‘é¡µ\nâœ… depends_on: EC2 SG",
      fillcolor = "#FFAB91"
    ];

    step11 [
      label = "æ­¥éª¤ 11: åˆ›å»º Green Launch Template\naws_launch_template.green\nAMI: Ubuntu 22.04\nInstance Type: t3.micro\nUser Data: ç»¿è‰²ç¯å¢ƒç½‘é¡µ\nâœ… depends_on: EC2 SG",
      fillcolor = "#A5D6A7"
    ];

    parallel2 [
      label = "å¹¶è¡Œåˆ›å»º",
      shape = diamond,
      fillcolor = "#FF8A65",
      fontsize = 10
    ];
  }

  // ==================== Stage 6: Auto Scaling Groups ====================
  subgraph cluster_stage6 {
    label = "ç¬¬ 6 é˜¶æ®µï¼šè®¡ç®—èµ„æºå±‚ (110-180 ç§’) - æå‰åˆ›å»º + ç­‰å¾…å°±ç»ª";
    style = filled;
    color = "#FFCDD2";
    fontsize = 12;
    fontcolor = "#B71C1C";

    step12 [
      label = "æ­¥éª¤ 12: åˆ›å»º Blue ASG\naws_autoscaling_group.blue\nDesired/Min/Max: 2\ntarget_group_arns: [blue TG]\nâš¡ wait_for_elb_capacity: 2\nâš¡ wait_for_capacity_timeout: 10m\nâš¡ force_delete: true\nâœ… depends_on: Blue TG + Blue LT\nâš ï¸ ç§»é™¤äº†å¯¹ Listener çš„ä¾èµ–",
      fillcolor = "#EF9A9A"
    ];

    wait2 [
      label = "â³ Terraform ç­‰å¾…å®ä¾‹å¥åº·ï¼ˆå…³é”®ï¼ï¼‰\n1. å¯åŠ¨ 2 ä¸ª EC2 å®ä¾‹ (~30s)\n2. æ‰§è¡Œ User Data è„šæœ¬ (~20s)\n3. æ³¨å†Œåˆ° Blue TG (~5s)\n4. ç¬¬ä¸€æ¬¡å¥åº·æ£€æŸ¥ (~15s)\n5. ç¬¬äºŒæ¬¡å¥åº·æ£€æŸ¥é€šè¿‡ âœ“ (~15s)\n\nTerraform è½®è¯¢ç¡®è®¤ï¼š2 ä¸ªå®ä¾‹çŠ¶æ€ä¸º healthy",
      shape = note,
      fillcolor = "#FFCDD2",
      fontsize = 10
    ];

    step13 [
      label = "æ­¥éª¤ 13: åˆ›å»º Green ASG\naws_autoscaling_group.green\n(å¦‚æœ enable_green_env = true)\nDesired/Min/Max: æ ¹æ®å˜é‡\nâš¡ wait_for_elb_capacity: green_count\nâš¡ wait_for_capacity_timeout: 10m\nâš¡ force_delete: true\nâœ… depends_on: Green TG + Green LT\nâš ï¸ ç§»é™¤äº†å¯¹ Listener/Rule çš„ä¾èµ–",
      fillcolor = "#A5D6A7"
    ];

    condition2 [
      label = "enable_green_env\n= true?",
      shape = diamond,
      fillcolor = "#E57373",
      fontsize = 10
    ];

    wait3 [
      label = "â³ Terraform ç­‰å¾… Green å®ä¾‹å¥åº·\nåŒæ ·çš„å¯åŠ¨å’Œå¥åº·æ£€æŸ¥æµç¨‹",
      shape = note,
      fillcolor = "#C8E6C9",
      fontsize = 10
    ];
  }

  // ==================== Stage 7: Routing (MOVED HERE) ====================
  subgraph cluster_stage7 {
    label = "ç¬¬ 7 é˜¶æ®µï¼šæµé‡è·¯ç”±å±‚ (180-190 ç§’) - å»¶ååˆ›å»ºï¼Œå®ä¾‹å·²å°±ç»ª âœ“";
    style = filled;
    color = "#C8E6C9";
    fontsize = 12;
    fontcolor = "#1B5E20";

    step14 [
      label = "æ­¥éª¤ 14: åˆ›å»º HTTP Listener\naws_lb_listener.http\nPort: 80\ndefault_action: forward â†’ blue TG\nâœ… depends_on: ALB + TGs + Blue ASG\nğŸ¯ å…³é”®ï¼šæ­¤æ—¶ Blue TG ä¸­å·²æœ‰å¥åº·å®ä¾‹ï¼",
      fillcolor = "#A5D6A7"
    ];

    step15 [
      label = "æ­¥éª¤ 15: åˆ›å»º Canary Listener Rule\naws_lb_listener_rule.canary\n(å¦‚æœ enable_green_env = true)\nåŠ æƒè½¬å‘:\n  Blue: 100%, Green: 0%\nâœ… depends_on: Listener + TGs\nğŸ¯ å…³é”®ï¼šä¸¤ä¸ªç¯å¢ƒéƒ½å·²å¥åº·ï¼",
      fillcolor = "#81C784"
    ];

    condition1 [
      label = "enable_green_env\n= true?",
      shape = diamond,
      fillcolor = "#66BB6A",
      fontsize = 10
    ];
  }

  // ==================== Stage 8: Verification ====================
  subgraph cluster_stage8 {
    label = "ç¬¬ 8 é˜¶æ®µï¼šéªŒè¯å’Œå®Œæˆ (180-200 ç§’)";
    style = filled;
    color = "#C8E6C9";
    fontsize = 12;
    fontcolor = "#2E7D32";

    step16 [
      label = "æ­¥éª¤ 16: éªŒè¯å¥åº·æ£€æŸ¥\næ‰€æœ‰ Target Group å®ä¾‹çŠ¶æ€: healthy\nALB å¼€å§‹æ¥æ”¶æµé‡",
      fillcolor = "#A5D6A7"
    ];

    step17 [
      label = "æ­¥éª¤ 17: è¾“å‡ºèµ„æºä¿¡æ¯\nalb_dns_name\nblue_asg_name\ngreen_asg_name (å¦‚æœå­˜åœ¨)",
      fillcolor = "#81C784"
    ];
  }

  // End node
  end [
    label = "âœ… åˆ›å»ºå®Œæˆ\nåŸºç¡€è®¾æ–½å°±ç»ª",
    shape = ellipse,
    fillcolor = "#4CAF50",
    fontcolor = white,
    fontsize = 13,
    style = "filled,bold"
  ];

  // ==================== Flow Connections ====================

  // Start
  start -> step1 [label="terraform apply", color="#4CAF50", penwidth=3];

  // Stage 1: Foundation
  step1 -> step2 [label="VPC ID"];
  step2 -> step3 [label="å¹¶è¡Œ", color="#2196F3"];
  step2 -> step4 [label="å¹¶è¡Œ", color="#2196F3"];
  step3 -> step5 [label="ç»§ç»­", style=dashed];
  step4 -> step5 [label="ç»§ç»­", style=dashed];

  // Stage 2: Security
  step5 -> step6 [label="SG é…ç½®"];
  step6 -> step7 [label="å®‰å…¨ç»„å°±ç»ª"];

  // Stage 3: Load Balancer
  step7 -> wait1 [label="åˆ›å»ºä¸­", style=dashed, color="#FF9800"];
  wait1 -> parallel1 [label="ALB active"];

  // Stage 4: Target Groups
  parallel1 -> step8 [label="å¹¶è¡Œ", color="#2196F3"];
  parallel1 -> step9 [label="å¹¶è¡Œ", color="#2196F3"];
  step8 -> parallel2 [label="Blue TG å°±ç»ª"];
  step9 -> parallel2 [label="Green TG å°±ç»ª"];

  // Stage 5: Launch Templates (æå‰åˆ›å»º)
  parallel2 -> step10 [label="å¹¶è¡Œ", color="#2196F3"];
  parallel2 -> step11 [label="å¹¶è¡Œ", color="#2196F3"];

  // Stage 6: Auto Scaling Groups (æå‰åˆ›å»º + ç­‰å¾…å¥åº·)
  step10 -> step12 [label="Blue LT å°±ç»ª"];
  step11 -> condition2 [label="Green LT å°±ç»ª"];

  step12 -> wait2 [label="åˆ›å»ºä¸­", style=dashed, color="#FF9800"];
  wait2 -> step14 [label="Blue å®ä¾‹å¥åº· âœ“", color="#4CAF50", penwidth=3];

  condition2 -> step13 [label="æ˜¯", color="#4CAF50"];
  condition2 -> step14 [label="å¦\n(è·³è¿‡ Green)", color="#9E9E9E", style=dashed];
  step13 -> wait3 [label="åˆ›å»ºä¸­", style=dashed, color="#FF9800"];
  wait3 -> step14 [label="Green å®ä¾‹å¥åº· âœ“", color="#4CAF50", penwidth=3];

  // Stage 7: Routing (å»¶ååˆ›å»ºï¼Œå®ä¾‹å·²å°±ç»ª)
  step14 -> condition1 [label="Listener å‡†å¤‡åˆ›å»º"];
  condition1 -> step15 [label="æ˜¯ï¼ˆåˆ›å»º Ruleï¼‰", color="#4CAF50"];
  condition1 -> step16 [label="å¦\n(è·³è¿‡ Rule)", color="#9E9E9E", style=dashed];
  step15 -> step16 [label="Rule å°±ç»ª"];

  // Stage 8: Verification
  step16 -> step17 [label="å¥åº·æ£€æŸ¥é€šè¿‡"];
  step17 -> end [label="å®Œæˆ", color="#4CAF50", penwidth=3];

  // ==================== Legend ====================
  subgraph cluster_legend {
    label = "å›¾ä¾‹è¯´æ˜";
    style = filled;
    color = white;
    fontsize = 12;
    rank = sink;

    node [shape=plaintext, fillcolor=white];

    legend [
      label=<
        <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="6">
          <TR><TD COLSPAN="2" BGCOLOR="#E3F2FD"><B>æµç¨‹ç¬¦å·</B></TD></TR>
          <TR>
            <TD ALIGN="LEFT">åœ†è§’çŸ©å½¢</TD>
            <TD ALIGN="LEFT">åˆ›å»ºæ­¥éª¤</TD>
          </TR>
          <TR>
            <TD ALIGN="LEFT">è±å½¢</TD>
            <TD ALIGN="LEFT">æ¡ä»¶åˆ¤æ–­ / å¹¶è¡Œç‚¹</TD>
          </TR>
          <TR>
            <TD ALIGN="LEFT">ä¾¿ç­¾</TD>
            <TD ALIGN="LEFT">ç­‰å¾… / è¯´æ˜</TD>
          </TR>
          <TR>
            <TD ALIGN="LEFT">æ¤­åœ†</TD>
            <TD ALIGN="LEFT">å¼€å§‹ / ç»“æŸ</TD>
          </TR>
          <TR><TD COLSPAN="2" BGCOLOR="#E3F2FD"><B>è¿çº¿ç±»å‹</B></TD></TR>
          <TR>
            <TD ALIGN="LEFT"><FONT COLOR="#2196F3">è“è‰²å®çº¿</FONT></TD>
            <TD ALIGN="LEFT">å¹¶è¡Œåˆ›å»º</TD>
          </TR>
          <TR>
            <TD ALIGN="LEFT"><FONT COLOR="#FF9800">æ©™è‰²è™šçº¿</FONT></TD>
            <TD ALIGN="LEFT">ç­‰å¾…çŠ¶æ€</TD>
          </TR>
          <TR>
            <TD ALIGN="LEFT">ç°è‰²è™šçº¿</TD>
            <TD ALIGN="LEFT">æ¡ä»¶è·³è¿‡</TD>
          </TR>
          <TR>
            <TD ALIGN="LEFT"><FONT COLOR="#4CAF50">ç»¿è‰²ç²—çº¿</FONT></TD>
            <TD ALIGN="LEFT">ä¸»æµç¨‹</TD>
          </TR>
          <TR><TD COLSPAN="2" BGCOLOR="#E3F2FD"><B>æ€»è€—æ—¶</B></TD></TR>
          <TR><TD COLSPAN="2" ALIGN="CENTER">
            <B>çº¦ 3-4 åˆ†é’Ÿ</B><BR/>
            (ä»… Blue ç¯å¢ƒ)<BR/>
            <B>çº¦ 5-6 åˆ†é’Ÿ</B><BR/>
            (Blue + Green ç¯å¢ƒ)
          </TD></TR>
        </TABLE>
      >
    ];
  }

  // Graph title
  label = <<BR/>
    <B><FONT POINT-SIZE="18" COLOR="#4CAF50">Terraform è“ç»¿éƒ¨ç½² - é›¶ä¸­æ–­åˆ›å»ºæµç¨‹å›¾</FONT></B><BR/>
    <BR/>
    <B><FONT COLOR="#F44336">å…³é”®å˜æ›´ï¼ˆè§£å†³ä¸šåŠ¡ä¸­æ–­é—®é¢˜ï¼‰ï¼š</FONT></B><BR/>
    â€¢ Listener depends_on: ALB + TGs + Blue ASG (ç­‰å¾…å®ä¾‹å¥åº·åæ‰åˆ›å»ºè·¯ç”±) âœ…<BR/>
    â€¢ Blue ASG ç§»é™¤äº†å¯¹ Listener çš„ä¾èµ–ï¼ˆé¿å…å¾ªç¯ï¼‰âœ…<BR/>
    â€¢ Green ASG ç§»é™¤äº†å¯¹ Listener/Rule çš„ä¾èµ–ï¼ˆé¿å…å¾ªç¯ï¼‰âœ…<BR/>
    <BR/>
    <B>é›¶ä¸­æ–­æµç¨‹ï¼š</B><BR/>
    1ï¸âƒ£ ç¬¬ 4 é˜¶æ®µï¼šåˆ›å»º Target Groups<BR/>
    2ï¸âƒ£ ç¬¬ 5 é˜¶æ®µï¼šåˆ›å»º Launch Templatesï¼ˆæå‰ï¼‰<BR/>
    3ï¸âƒ£ ç¬¬ 6 é˜¶æ®µï¼šåˆ›å»º ASG + ç­‰å¾…å®ä¾‹å¥åº·ï¼ˆTerraform è½®è¯¢ TG çŠ¶æ€ï¼‰<BR/>
    4ï¸âƒ£ ç¬¬ 7 é˜¶æ®µï¼šåˆ›å»º Listenerï¼ˆæ­¤æ—¶ Blue TG å·²æœ‰å¥åº·å®ä¾‹ï¼‰âœ“<BR/>
    5ï¸âƒ£ ç¬¬ 8 é˜¶æ®µï¼šåˆ›å»º Canary Ruleï¼ˆä¸¤ä¸ªç¯å¢ƒéƒ½å¥åº·ï¼‰âœ“<BR/>
    <BR/>
    <B>ä¼˜åŒ–é…ç½®ï¼š</B><BR/>
    â€¢ wait_for_elb_capacity=instance_count (ç­‰å¾…å®ä¾‹å¥åº·) âœ…<BR/>
    â€¢ wait_for_capacity_timeout=10m (ç»™å®ä¾‹å……è¶³å¯åŠ¨æ—¶é—´) âœ…<BR/>
    â€¢ deregistration_delay=30s (å¿«é€Ÿæ³¨é”€)<BR/>
    â€¢ force_delete=true (å¼ºåˆ¶åˆ é™¤ä¿æŠ¤)<BR/>
    â€¢ timeout=15m (è¶…æ—¶ä¿æŠ¤)<BR/>
    â€¢ create_before_destroy=true (é›¶åœæœºæ›´æ–°)<BR/>
    <BR/>
    <B>ç»“æœï¼šæµé‡è·¯ç”±æ—¶å®ä¾‹å·²å°±ç»ªï¼Œæ—  503 é”™è¯¯ï¼</B><BR/>
    <BR/>
  >;
  labelloc = t;
  fontsize = 14;
}
